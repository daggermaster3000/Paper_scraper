<!-- main.html -->

<!DOCTYPE html>
<html>

<head>
    <link rel="shortcut icon" type="image/x-icon" href="/assets/PG.ico">
    <meta charset="UTF-8">
    <title>Paper Mat√©</title>
    <script type="text/javascript" src="/eel.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

    <h1>Paper Mate</h1>

    <div id="inputContainer">
        <input type="text" id="keywordInput" class="input-field" placeholder="Enter a keyword">
        <input type="text" id="pagesInput" class="input-field" placeholder="Enter the number of pages to search">
        <button class="button" onClick="scrape_papers();">Search</button>
        <input id="groupInput" type="text" class="input-field" list="groupList" placeholder="Enter a group name" />
        <datalist>
        </datalist>
        <button class="button" onClick="createGroup();">Create</button>
    </div>
    <div class="tab">
        <button class="tablinks" id="defaultOpen" onclick="openCity(event, 'Results')">Results</button>
        <button class="tablinks" onclick="openCity(event, 'ReadPapers'); LoadReadPapers();">Reading List</button>
        <button class="tablinks" onclick="openCity(event, 'Tokyo')">New Papers</button>
    </div>
    <div id="loader1" class="loader"></div>

    <div id="Results" class="tabcontent">
        <div class="papers table-container" id="results">
        </div>
    </div>

    <div id="ReadPapers" class="tabcontent">
        <button class="collapsible">Toggle Section</button>
        <div class="content" style="display: none;">
            <p>This is the collapsible content.</p>
            <div class="readpapers table-container" id="readpapers">
            </div>
        </div>

    </div>


    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>

    <script type="text/javascript">

        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();

        // show the loader
        function showLoader() {
            document.getElementById("loader1").style.display = "block";
            console.log("showing loader")
            document.getElementById("results").style.display = "none";
        }

        // hide the loader
        function hideLoader() {
            document.getElementById("loader1").style.display = "none";
            document.getElementById("results").style.display = "block";
        }

        function scrape_papers() {
            document.getElementById("defaultOpen").click();
            showLoader();
            // Get keyword input
            var inputElement = document.getElementById("keywordInput");
            var userInput = inputElement.value;
            // Get pages input
            var inputElement = document.getElementById("pagesInput");
            var pagesInput = inputElement.value;
            eel.scrape_papers(userInput, pagesInput)();
            load_csv(function () {
                hideLoader();
            });

        }

        // Function to initialize DataTables
        function initializeDataTables() {
            $('#myTable').DataTable();
        }

        function LoadReadPapers() {
            eel.load_csv("read_papers.csv", "readTable", "myreadTable")(function (content) {
                // clear the div
                var myDiv = document.getElementById("readpapers");
                myDiv.innerHTML = "";

                // Update the div 
                document.querySelector(".readpapers").innerHTML = content;

                //Add checkboxes
                var table = document.getElementById("myreadTable");
                var tbody = table.getElementsByTagName("tbody")[0];
                var rows = tbody.getElementsByTagName("tr");

                // Add checkboxes to each row
                for (var i = 0; i < rows.length; i++) {
                    // Create a new cell for the checkbox
                    var cell = document.createElement("td");

                    // Create a checkbox element
                    var checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.id = "myCheckbox";
                    checkbox.checked = true;
                    // Create the label for the checkbox
                    //var label = document.createElement("label");
                    //label.textContent = "Toggle Function";
                    //label.htmlFor = "myCheckbox";

                    // Append the checkbox to the cell
                    cell.appendChild(checkbox);
                    //cell.appendChild(label);

                    // Add event handlers
                    checkbox.addEventListener("change", handleCheckboxChange);

                    // Insert the new cell as the first cell in the row
                    rows[i].insertBefore(cell, rows[i].firstChild);
                }
                // Add header for the new column
                var headerRow = table.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0];
                var headerCell = document.createElement("th");
                headerCell.textContent = "Reading";
                headerRow.insertBefore(headerCell, headerRow.firstChild);
                $('#myreadTable').DataTable();
            })
        }

        function load_csv(callback) {
            eel.load_csv("papers.csv", "table", "myTable")(function (content) {
                // Update the div 
                document.querySelector(".papers").innerHTML = content;

                //Add chckboxes
                var table = document.getElementById("myTable");
                var tbody = table.getElementsByTagName("tbody")[0];
                var rows = tbody.getElementsByTagName("tr");

                // Add checkboxes to each row
                for (var i = 0; i < rows.length; i++) {
                    // Create a new cell for the checkbox
                    var cell = document.createElement("td");

                    // Create a checkbox element
                    var checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.id = "myCheckbox";
                    // Create the label for the checkbox
                    //var label = document.createElement("label");
                    //label.textContent = "Toggle Function";
                    //label.htmlFor = "myCheckbox";

                    // Append the checkbox to the cell
                    cell.appendChild(checkbox);
                    //cell.appendChild(label);

                    // Add event handlers
                    checkbox.addEventListener("change", handleCheckboxChange);

                    // Insert the new cell as the first cell in the row
                    rows[i].insertBefore(cell, rows[i].firstChild);
                }
                // Add header for the new column
                var headerRow = table.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0];
                var headerCell = document.createElement("th");
                headerCell.textContent = "Add to reading list";
                headerRow.insertBefore(headerCell, headerRow.firstChild);
                initializeDataTables();
                callback();
            })
        }

        function handleCheckboxChange(event) {
            var checkbox = event.target;

            // Get the parent row of the checkbox
            var row = checkbox.parentNode.parentNode;

            // Get the title cell in the same row
            var titleCell = row.getElementsByTagName("td")[1];

            // Get the title text
            var title = titleCell.textContent;

            console.log(title);

            if (event.target.checked) {
                // Checkbox is checked, call functionA
                AddReadEntry(title);
            } else {
                // Checkbox is unchecked, call functionB
                RemoveReadEntry(title);
                uncheckCheckbox(title)
            }
            //update the table as well after 5 sec
            function waitThreeSeconds(callback) {
                setTimeout(callback, 5000); // 5 seconds
            }
            waitThreeSeconds(function () {
                LoadReadPapers();
            });


        }
        function AddReadEntry(title) {
            console.log("Adding read entry");
            // Get keyword input
            var inputElement = document.getElementById("keywordInput");
            var keyword = inputElement.value;
            eel.add_read_entry(keyword, title);
        }

        function RemoveReadEntry(title) {
            console.log("Removing read entry");
            // Get keyword input
            var inputElement = document.getElementById("keywordInput");
            var keyword = inputElement.value;
            eel.remove_read_entry(keyword, title);
        }

        // Code for the tabs
        function openCity(evt, cityName) {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(cityName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function uncheckCheckbox(elementText) {
            //uncheck checkbox in the results table
            var table = document.getElementById("myTable");
            var rows = table.getElementsByTagName('tr');

            for (var i = 1; i < rows.length; i++) {
                var row = rows[i];
                console.log(row)
                var cells = row.getElementsByTagName('td');
                var checkbox = cells[0].querySelector('input[type="checkbox"]');
                var cellText = cells[1].textContent;
                if (cellText === elementText) {
                    checkbox.checked = false;
                    break;
                }
            }
            console.log("unchecked entry in results table")
        }




        //code for the collapsible
        let groupList = []
        function createGroup() {
            // get the group name
            input = document.getElementById('groupInput')
            groupName = input.value;
            groupList.push(groupName)
            //Create the html
            //Create the button
            var collapsibleButton = document.createElement('button');
            collapsibleButton.textContent = groupName;
            collapsibleButton.classList.add('collapsible');
            collapsibleButton.setAttribute("id", "collapsibleButton")
            console.log("2")
            //Create the content div
            var content = document.createElement('div');
            content.style.display = 'none';
            content.classList.add('content');
            content.innerHTML = '<p>This is the collapsible content.</p>';

            //Append to the tab section
            var container = document.getElementById('ReadPapers');
            container.appendChild(collapsibleButton);
            container.appendChild(content);


            var coll = document.getElementsByClassName("collapsible");
        var i;

        // Make the stuff collapsible
        for (i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var content = this.nextElementSibling;
            if (content.style.display === "block") {
            content.style.display = "none";
            } else {
            content.style.display = "block";
            }
        });
        }
            //Manage the backend

        }

    </script>

</html>